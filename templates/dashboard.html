{% extends "base.html" %}

{% block title %}Dashboard Financeiro{% endblock %}

{% block head_extra %}
    <style>
        :root { --cor-principal: #2b5735; --cor-sucesso: #28a745; --cor-perigo: #d9534f; --cor-texto-claro: #1c1c1c; --cor-fundo-claro: #f8f9fa; }
        body { background-color: var(--cor-fundo-claro); color: var(--cor-texto-claro); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .saldo-total { font-size: 1.8rem; font-weight: 700; color: var(--cor-principal); }
        .grafico-container { position: relative; height: 350px; width: 100%; margin: 0 auto; }
        .card { box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e9eef0; transition: transform 0.2s ease-in-out; }
        .card:hover { transform: translateY(-5px); }
        .badge-categoria { color: #fff; } /* Garante que o texto da badge seja branco */

    </style>
{% endblock %}

{% block content %}
<div>
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Balanço Geral</h1>
        <a href="{{ url_for('gerenciar_meta') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-bullseye"></i> Definir Meta Mensal
        </a>
    </div>
    <h1 class="h4" style="color:#055160">Saldo Atual <i class="bi bi-cash-stack" style="color:#54Ab68"></i></h1>
    <p class="mb-5"><span class="saldo-total" style="color:#055160">R$ {{ saldo | format_brl }}</span></p>

    <div class="row text-center mb-5">
        <div class="col-lg-4 mb-4">
            <div class="card h-100"><div class="card-body grafico-container"><canvas id="myPizzaChart"></canvas></div></div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="card h-100"><div class="card-body grafico-container"><canvas id="metaChart"></canvas></div></div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="card h-100"><div class="card-body grafico-container"><canvas id="gastosCategoriaChart"></canvas></div></div>
        </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-5 mb-3">
        <h2 class="mb-0">Gastos Programados do Mês</h2>
        <a href="{{ url_for('adicionar_gasto_programado') }}" class="btn btn-success btn-sm">
            <i class="bi bi-plus-circle"></i> Adicionar Gasto
        </a>
    </div>

    <div class="row">
        {% for gasto in gastos_programados %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h5 class="card-title">{{ gasto.descricao }}</h5>
                        <span class="fw-bold fs-5 text-danger">R$ {{ gasto.valor_parcela | format_brl }}</span>
                    </div>

                    {% if not gasto.recorrente %}
                    <p class="card-text mb-2 text-muted">
                        Progresso: {{ gasto.parcelas_pagas }} de {{ gasto.total_parcelas }} parcelas pagas.
                    </p>
                    <div class="progress mb-3" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: {{ (gasto.parcelas_pagas / gasto.total_parcelas) * 100 }}%;"
                             aria-valuenow="{{ gasto.parcelas_pagas }}"
                             aria-valuemin="0"
                             aria-valuemax="{{ gasto.total_parcelas }}"></div>
                    </div>
                    {% else %}
                    <p class="card-text mb-2 text-muted">Pagamento recorrente mensal.</p>
                    {% endif %}

                    <div class="d-flex justify-content-end">
                         <form method="POST" action="{{ url_for('pagar_parcela_gasto', id=gasto.id_gasto) }}" class="me-2">
                            <button type="submit" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-check-circle"></i> Marcar como Pago
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('apagar_gasto_programado', id=gasto.id_gasto) }}" onsubmit="return confirm('Tem certeza que deseja apagar este gasto programado?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="alert alert-info text-center">Nenhum gasto programado para este mês.</div>
        </div>
        {% endfor %}
    </div>

    <div class="mt-4">
        <h4 class="text-center">Impacto no Saldo Mensal</h4>
        <p class="text-center text-muted">Total Programado: <span class="text-danger fw-bold">R$ {{ total_gastos_programados_mes | format_brl }}</span></p>

        {% if total_gastos_programados_mes > saldo %}
            <div class="progress-stacked">
                <div class="progress" role="progressbar" style="width: 100%; height: 25px;">
                    <div class="progress-bar bg-danger" style="width: 100%;">SALDO INSUFICIENTE</div>
                </div>
            </div>
            <p class="text-center mt-2 fw-bold">
                Faltará: <span style="color: #6c757d;">R$ {{ (total_gastos_programados_mes - saldo) | format_brl }}</span>
            </p>
        {% else %}
            <div class="progress" style="height: 25px;">
                <div class="progress-bar bg-danger" role="progressbar" style="width: {{ percentual_gastos }}%;" aria-valuenow="{{ percentual_gastos }}" aria-valuemin="0" aria-valuemax="100">
                    Gastará: R$ {{ total_gastos_programados_mes | format_brl }}
                </div>
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ percentual_sobra }}%;" aria-valuenow="{{ percentual_sobra }}" aria-valuemin="0" aria-valuemax="100">
                    Restará: R$ {{ saldo_apos_gastos | format_brl }}
                </div>
            </div>
        {% endif %}
    </div>

    <div class="d-flex justify-content-between align-items-center mt-5 mb-2">
        <h2 class="mb-0">Lista de Transações</h2>
        <div class="d-flex align-items-center">
            <form action="{{ url_for('gerar_relatorio_pdf') }}" method="POST" class="d-flex align-items-center me-3">
                <select name="periodo" class="form-select form-select-sm me-2" style="width: auto;">
                    <option value="mes">Mês Atual</option>
                    <option value="15dias">Últimos 15 Dias</option>
                    <option value="5dias">Últimos 5 Dias</option>
                </select>
                <button type="submit" class="btn btn-success btn-sm">
                    <i class="bi bi-file-earmark-pdf"></i> Gerar Relatório
                </button>
            </form>
            <form action="{{ url_for('apagar_todas_transacoes') }}" method="POST"
                  onsubmit="return confirm('Você tem certeza que deseja apagar TODAS as suas transações? Esta ação não pode ser desfeita.');">
                <button type="submit" class="btn btn-danger btn-sm">
                    <i class="bi bi-trash"></i> Apagar Todas
                </button>
            </form>
        </div>
    </div>


    <div class="table-responsive small">
        <table class="table table-striped table-hover table-sm">
            <thead>
                <tr>
                    <th scope="col">Data</th>
                    <th scope="col">Tipo</th>
                    <th scope="col">Categoria</th>
                    <th scope="col" class="text-end">Valor (R$)</th>
                    <th scope="col">Descrição</th>
                    <th scope="col">Beneficiário</th>
                    <th scope="col">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for transacao in transacoes %}
                    <tr>
                        <td>{{ transacao.data.split('T')[0] }}</td>
                        <td>
                            <span class="badge text-bg-{{ 'success' if transacao.tipo == 'receita' else 'danger' }}">
                                {{ transacao.tipo | capitalize }}
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-categoria"
                                  style="background-color: {{ cores_categoria.get(transacao.categoria, '#6c757d') }};">
                                {{ transacao.categoria | default('Outros') }}
                            </span>
                        </td>
                        <td class="fw-bold text-end text-{{ 'success' if transacao.tipo == 'receita' else 'danger' }}">
                            {{ transacao.valor | format_brl }}
                        </td>
                        <td>{{ transacao.descricao }}</td>
                        <td>{{ transacao.beneficiario }}</td>
                        <td>
                            <a href="{{ url_for('editar_transacao', id=transacao.id) }}" class="btn btn-sm btn-outline-secondary" title="Editar"><i class="bi bi-pencil"></i></a>
                            <form method="POST" action="{{ url_for('apagar_transacao', id=transacao.id) }}" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Apagar" onclick="return confirm('Tem a certeza que deseja apagar esta transação?');"><i class="bi bi-trash"></i></button>
                            </form>
                        </td>
                    </tr>
                {% else %}
                    <tr><td colspan="7" class="text-center p-4">Nenhuma transação encontrada.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctxBalanço = document.getElementById('myPizzaChart');
            if (ctxBalanço) {
                new Chart(ctxBalanço, {
                    type: 'doughnut',
                    data: {
                        labels: ['Receitas (R$)', 'Despesas (R$)'],
                        datasets: [{
                            data: [{{ entrada_total | tojson }}, {{ saida_total | tojson }}],
                            backgroundColor: ['#28a745', '#d9534f']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: true, text: 'Balanço de Receitas e Despesas' }
                        }
                    }
                });
            }

            const ctxMeta = document.getElementById('metaChart');
            if (ctxMeta) {
                const META_INVESTIMENTO = {{ meta_investimento | tojson }};
                const TOTAL_INVESTIDO = {{ total_investido | tojson }};
                const restanteParaMeta = Math.max(0, META_INVESTIMENTO - TOTAL_INVESTIDO);
                const porcentagemAtingida = META_INVESTIMENTO > 0 ? (TOTAL_INVESTIDO / META_INVESTIMENTO * 100).toFixed(1) : 0;
                new Chart(ctxMeta, {
                    type: 'doughnut',
                    data: {
                        labels: ['Atingido (R$)', 'Faltando (R$)'],
                        datasets: [{
                            data: [TOTAL_INVESTIDO, restanteParaMeta],
                            backgroundColor: ['#0d6efd', '#e9ecef']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: true, text: `Meta de Investimento: ${porcentagemAtingida}%` }
                        }
                    }
                });
            }

            const ctxGastosCategoria = document.getElementById('gastosCategoriaChart');
            if (ctxGastosCategoria) {
                const categorias_labels = {{ categorias_labels | tojson }};
                const gastos_valores = {{ gastos_valores | tojson }};
                const cores_map = {{ cores_categoria | tojson }};
                const default_color = '#6c757d';

                const backgroundColors = categorias_labels.map(label => cores_map[label] || default_color);

                if (gastos_valores.length > 0) {
                    new Chart(ctxGastosCategoria, {
                        type: 'pie',
                        data: {
                            labels: categorias_labels,
                            datasets: [{
                                label: 'Gastos por Categoria',
                                data: gastos_valores,
                                backgroundColor: backgroundColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'bottom', labels: { boxWidth: 12 } },
                                title: { display: true, text: 'Gastos do Mês por Categoria' }
                            }
                        }
                    });
                } else {
                    const ctx = ctxGastosCategoria.getContext('2d');
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.font = "14px 'Segoe UI'";
                    ctx.fillText('Nenhuma despesa registada este mês.', ctxGastosCategoria.width / 2, ctxGastosCategoria.height / 2);
                }
            }
        });
    </script>
{% endblock %}